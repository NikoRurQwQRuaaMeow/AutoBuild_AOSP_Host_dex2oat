name: Build Android 16 Host dex2oat

on:
  workflow_dispatch: # 手动触发

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Maximize Build Space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 2048
          temp-reserve-mb: 1024
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git-core gnupg flex bison build-essential zip curl zlib1g-dev gcc-multilib g++-multilib libc6-dev-i386 libncurses5 lib32ncurses5-dev x11proto-core-dev libx11-dev lib32z1-dev libgl1-mesa-dev libxml2-utils xsltproc unzip fontconfig python3

      - name: Install Repo
        run: |
          mkdir ~/bin
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod a+x ~/bin/repo
          echo "$HOME/bin" >> $GITHUB_PATH

      - name: Repo Init and Sync
        run: |
          mkdir aosp && cd aosp
          # 初始化 Android 16/Master 分支
          repo init -u https://android.googlesource.com/platform/manifest -b master --depth=1
          
          # 只同步构建 dex2oat 核心链路的仓库
          repo sync -c -j$(nproc) --no-tags --no-current-branch \
            platform/art \
            platform/build/soong \
            platform/build/blueprint \
            platform/build/make \
            platform/external/zlib \
            platform/external/icu \
            platform/system/core \
            platform/system/libbase \
            platform/system/libziparchive \
            platform/prebuilts/clang/host/linux-x86 \
            platform/prebuilts/build-tools \
            platform/prebuilts/go/linux-x86
          
          # 关键步：删除 .repo 节省空间
          rm -rf .repo

      - name: Build dex2oat
        run: |
          cd aosp
          source build/envsetup.sh
          # 我们编译的是 host 工具，lunch 目标不影响工具架构
          lunch aosp_arm64-userdebug
          # 使用 soong 编译 host 版 dex2oat
          m dex2oat

      - name: Prepare Artifacts
        run: |
          mkdir -p publish/lib64
          cp aosp/out/host/linux-x86/bin/dex2oat publish/
          # 拷贝必要的运行时动态库
          cp aosp/out/host/linux-x86/lib64/libart.so publish/lib64/ || true
          cp aosp/out/host/linux-x86/lib64/libbase.so publish/lib64/ || true
          cp aosp/out/host/linux-x86/lib64/libartbase.so publish/lib64/ || true
          cp aosp/out/host/linux-x86/lib64/libdexfile.so publish/lib64/ || true
          cp aosp/out/host/linux-x86/lib64/liblz4.so publish/lib64/ || true
          cp aosp/out/host/linux-x86/lib64/libziparchive.so publish/lib64/ || true
          cp aosp/out/host/linux-x86/lib64/libz.so publish/lib64/ || true

      - name: Upload dex2oat Binary
        uses: actions/upload-artifact@v4
        with:
          name: dex2oat-host-x86_64
          path: publish/
