name: Build Android 16 Host dex2oat

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Maximize Build Space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 2048
          temp-reserve-mb: 1024
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git-core gnupg flex bison build-essential zip curl zlib1g-dev gcc-multilib g++-multilib libc6-dev-i386 libncurses5 lib32ncurses5-dev x11proto-core-dev libx11-dev lib32z1-dev libgl1-mesa-dev libxml2-utils xsltproc unzip fontconfig python3

      - name: Install Repo
        run: |
          mkdir -p ~/bin
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod a+x ~/bin/repo
          echo "$HOME/bin" >> $GITHUB_PATH

      - name: Repo Init and Sync
        run: |
          mkdir aosp && cd aosp
          # 初始化 Android Master 分支 (Android 16 所在)
          repo init -u https://android.googlesource.com/platform/manifest -b master --depth=1
          
          # 使用相对路径同步，确保 build/make 等关键路径存在
          # 增加了更多 external 依赖库以防止编译 Android 16 时报错
          repo sync -c -j$(nproc) --no-tags --no-current-branch \
            build/make \
            build/soong \
            build/blueprint \
            art \
            external/zlib \
            external/icu \
            external/libcxx \
            external/libcxxabi \
            external/lz4 \
            external/zstd \
            external/fmtlib \
            system/core \
            system/libbase \
            system/libziparchive \
            system/logging \
            prebuilts/clang/host/linux-x86 \
            prebuilts/build-tools \
            prebuilts/go/linux-x86
          
          # 彻底删除 .repo 以腾出约 5GB+ 空间
          rm -rf .repo

      - name: Build dex2oat
        run: |
          cd aosp
          source build/envsetup.sh
          # lunch 一个基础目标即可，我们要的是 host 工具
          lunch aosp_arm64-userdebug
          # 使用 m 直接编译 host 版 dex2oat
          m dex2oat

      - name: Prepare Artifacts
        run: |
          mkdir -p publish/lib64
          # 寻找生成的二进制文件
          CP_BASE="aosp/out/host/linux-x86"
          cp $CP_BASE/bin/dex2oat publish/
          
          # 使用动态搜寻方式拷贝依赖库，避免因 Android 16 库名变化导致失败
          LIBS=("libart" "libbase" "libartbase" "libdexfile" "liblz4" "libziparchive" "libz" "liblog" "libc++")
          for lib in "${LIBS[@]}"; do
            find $CP_BASE/lib64 -name "${lib}.so" -exec cp {} publish/lib64/ \;
          done

      - name: Upload dex2oat Binary
        uses: actions/upload-artifact@v4
        with:
          name: dex2oat-android16-host
          path: publish/
