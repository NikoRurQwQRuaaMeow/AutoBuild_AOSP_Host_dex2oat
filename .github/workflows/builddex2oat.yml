name: Build Android 16 Host dex2oat

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Maximize Build Space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 2048
          temp-reserve-mb: 1024
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git-core gnupg flex bison build-essential zip curl zlib1g-dev gcc-multilib g++-multilib libc6-dev-i386 libncurses5 lib32ncurses5-dev x11proto-core-dev libx11-dev lib32z1-dev libgl1-mesa-dev libxml2-utils xsltproc unzip fontconfig python3

      - name: Install Repo
        run: |
          mkdir -p ~/bin
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod a+x ~/bin/repo
          echo "$HOME/bin" >> $GITHUB_PATH

      - name: Repo Init and Sync
        run: |
          mkdir aosp && cd aosp
          # 初始化 Android 16 Master 分支 (由于同步较多，确保网络稳定)
          repo init -u https://android.googlesource.com/platform/manifest -b master --depth=1
          
          # 同步核心组件：增加了 system/logging 等 Android 16 强依赖项
          repo sync -c -j$(nproc) --no-tags --no-current-branch --no-clone-bundle \
            build/make \
            build/soong \
            build/blueprint \
            art \
            system/core \
            system/libbase \
            system/logging \
            system/libziparchive \
            external/libcxx \
            external/libcxxabi \
            external/golang-protobuf \
            external/starlark-go \
            external/zlib \
            external/fmtlib \
            prebuilts/clang/host/linux-x86 \
            prebuilts/build-tools \
            prebuilts/go/linux-x86
          
          rm -rf .repo

      - name: Build dex2oat
        run: |
          cd aosp
          
          # 1. 深度伪造 Release Config 结构 (Android 16 必需)
          mkdir -p vendor/google/release/release_configs
          cat <<EOF > vendor/google/release/release_config_map.textproto
          default_containers: "none"
          entries {
            name: "trunk_staging"
            path: "vendor/google/release/release_configs/trunk_staging.textproto"
          }
          EOF
          echo 'name: "trunk_staging"' > vendor/google/release/release_configs/trunk_staging.textproto
          
          # 2. 【核心修复】遵循 Android 16 变量优先级
          # 仅设置 RELEASE_ 开头的变量，让系统自动推导代号 (VanillaIceCream)
          export RELEASE_PLATFORM_VERSION=16
          export RELEASE_PLATFORM_SDK_VERSION=35
          
          # 3. 屏蔽 VNDK 检查并允许缺失非核心依赖
          export SKIP_VNDK_VAR_CHECK=true
          export SOONG_ALLOW_MISSING_DEPENDENCIES=true
          
          # 4. 指定编译目标
          export TARGET_PRODUCT=aosp_x86_64
          export TARGET_RELEASE=trunk_staging
          export TARGET_BUILD_VARIANT=userdebug
          
          # 5. 启动 Soong 编译引擎
          source build/envsetup.sh
          ./build/soong/soong_ui.bash --make-mode dex2oat

      - name: Prepare Artifacts
        run: |
          mkdir -p publish/lib64
          OUT_DIR="aosp/out/host/linux-x86"
          
          if [ -d "$OUT_DIR" ]; then
            # 拷贝主程序
            find $OUT_DIR/bin -name "dex2oat*" -exec cp {} publish/ \;
            
            # 拷贝核心动态链接库 (Android 16 的 dex2oat 极其依赖这些 so)
            LIBS=("libart" "libbase" "libartbase" "libdexfile" "liblz4" "libziparchive" "libz" "liblog" "libc++")
            for lib in "${LIBS[@]}"; do
              find $OUT_DIR/lib64 -name "${lib}.so" -exec cp {} publish/lib64/ \;
            done
            
            echo "Android 16 Build Success: $(date)" > publish/info.txt
          else
            echo "Build failed! Checking if any output exists..."
            ls -R aosp/out || true
            exit 1
          fi

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: dex2oat-android16-x86_64
          path: publish/